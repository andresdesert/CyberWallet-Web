// ðŸŽ¨ CYBERWALLET UNIFIED THEME SYSTEM 2025-2026
// Sistema de temas unificado con design tokens vanguardistas OKLCH
// Optimizado para demo y experiencia de usuario premium con contraste AAA

import React, { createContext, useContext, useEffect, useMemo, useState, useCallback } from 'react';
import { ThemeProvider as MuiThemeProvider, createTheme, responsiveFontSizes } from '@mui/material/styles';
import { CssBaseline, useMediaQuery } from '@mui/material';
import type { Theme, PaletteMode } from '@mui/material/styles';
import { getActiveTokens, generateCSSVariables, type ColorTokens } from '@/theme/tokens/colorTokens';

// ðŸŽ¯ Funciones utilitarias para reemplazar DESIGN_TOKENS
const withAlpha = (color: string, alpha: number): string => {
  return `color-mix(in srgb, ${color} ${Math.round(alpha * 100)}%, transparent)`;
};

const glassEffect = {
  medium: (colorScheme: PaletteMode) => ({
    background: colorScheme === 'dark' 
      ? 'rgba(13, 15, 17, 0.85)' 
      : 'rgba(255, 255, 255, 0.85)',
    backdropFilter: 'blur(12px)',
    border: '1px solid',
    borderColor: colorScheme === 'dark' 
      ? 'rgba(255, 255, 255, 0.1)' 
      : 'rgba(0, 0, 0, 0.1)',
  })
};

// ðŸŽ¯ Extensiones de tipos para MUI con nuevos tokens
declare module '@mui/material/styles' {
  interface Palette {
    custom: {
      // Superficies mejoradas
      bodyBackgroundPrimary: string;
      bodyBackgroundSecondary: string;
      glassBorder: string;
      neumoSurface: string;
      neumoLightShadow: string;
      neumoDarkShadow: string;
      
      // Colores base
      primary: string;
      secondary: string;
      accent: string;
      info: string;
      surface: string;
      
      // Textos optimizados
      textPrimary: string;
      textSecondary: string;
      textTertiary: string;
      textInverse: string;
      
      // Estados semÃ¡nticos
      success: string;
      warning: string;
      error: string;
      
      // Bordes
      borderLight: string;
      borderDefault: string;
      borderStrong: string;
      borderInteractive: string;
    };
  }

  interface PaletteOptions {
    custom?: {
      bodyBackgroundPrimary?: string;
      bodyBackgroundSecondary?: string;
      glassBorder?: string;
      neumoSurface?: string;
      neumoLightShadow?: string;
      neumoDarkShadow?: string;
      primary?: string;
      secondary?: string;
      accent?: string;
      info?: string;
      surface?: string;
      textPrimary?: string;
      textSecondary?: string;
      textTertiary?: string;
      textInverse?: string;
      success?: string;
      warning?: string;
      error?: string;
      borderLight?: string;
      borderDefault?: string;
      borderStrong?: string;
      borderInteractive?: string;
    };
  }

  interface TypographyVariants {
    display1: React.CSSProperties;
    display2: React.CSSProperties;
    display3: React.CSSProperties;
  }

  interface TypographyVariantsOptions {
    display1?: React.CSSProperties;
    display2?: React.CSSProperties;
    display3?: React.CSSProperties;
  }
}

// ðŸŽ¯ Tipos del contexto
export type ThemeMode = 'light' | 'dark' | 'auto';
export type ColorScheme = 'light' | 'dark';

interface UnifiedThemeContextType {
  mode: ThemeMode;
  colorScheme: ColorScheme;
  setMode: (mode: ThemeMode) => void;
  toggleColorScheme: () => void;
  systemPrefersDark: boolean;
  theme: Theme;
}

const UnifiedThemeContext = createContext<UnifiedThemeContextType | undefined>(undefined);

// ðŸŽ¨ FUNCIÃ“N PARA CREAR TEMA PROFESIONAL 2025-2026
const createProfessionalTheme = (colorScheme: ColorScheme): Theme => {
  const isLight = colorScheme === 'light';
  
  // ðŸš€ Tokens semÃ¡nticos OKLCH para mÃ¡ximo contraste
  const semanticTokens = getActiveTokens(colorScheme === 'dark');

  const glass = glassEffect.medium(colorScheme);

  const baseTheme = createTheme({
    palette: {
      mode: colorScheme,
      
      // ðŸŽ¨ Colores primarios basados en tokens semÃ¡nticos
      primary: {
        main: semanticTokens.text.brand,
        light: semanticTokens.border.interactive,
        dark: semanticTokens.text.brand,
        contrastText: semanticTokens.text.inverse,
      },

      // ðŸŒ¿ Colores secundarios modernos
      secondary: {
        main: semanticTokens.border.interactive,
        light: semanticTokens.text.brand,
        dark: semanticTokens.text.brand,
        contrastText: semanticTokens.text.inverse,
      },

      // âœ… Estados semÃ¡nticos
      success: {
        main: semanticTokens.financial.positive,
        light: withAlpha(semanticTokens.financial.positive, 0.1),
        dark: semanticTokens.financial.positive,
        contrastText: semanticTokens.text.inverse,
      },

      warning: {
        main: semanticTokens.financial.warning,
        light: withAlpha(semanticTokens.financial.warning, 0.1),
        dark: semanticTokens.financial.warning,
        contrastText: semanticTokens.text.inverse,
      },

      error: {
        main: semanticTokens.financial.negative,
        light: withAlpha(semanticTokens.financial.negative, 0.1),
        dark: semanticTokens.financial.negative,
        contrastText: semanticTokens.text.inverse,
      },

      info: {
        main: semanticTokens.financial.info,
        light: withAlpha(semanticTokens.financial.info, 0.1),
        dark: semanticTokens.financial.info,
        contrastText: semanticTokens.text.inverse,
      },

      // ðŸŽ¨ Superficies basadas en nuestros tokens
      background: {
        default: semanticTokens.surface.page,
        paper: semanticTokens.surface.primary,
      },

      // ðŸ“ Textos semÃ¡nticos
      text: {
        primary: semanticTokens.text.primary,
        secondary: semanticTokens.text.secondary,
        disabled: semanticTokens.text.tertiary,
      },

      // ðŸ”² Divisores y bordes
      divider: semanticTokens.border.subtle,
    },

    // ðŸ“ TipografÃ­a moderna
    typography: {
      fontFamily: '"Inter", "Roboto", "Helvetica", "Arial", sans-serif',
      fontWeightLight: 300,
      fontWeightRegular: 400,
      fontWeightMedium: 500,
      fontWeightBold: 700,
    },

    // ðŸŽ¨ Componentes personalizados
    components: {
      MuiCssBaseline: {
        styleOverrides: {
          body: {
            // ðŸŒŸ Background igual al LandingPage con gradient premium
            background: colorScheme === 'dark' 
              ? `
                linear-gradient(135deg, 
                  oklch(12% 0.02 220) 0%, 
                  oklch(8% 0.03 250) 50%, 
                  oklch(10% 0.02 200) 100%
                ),
                radial-gradient(circle at 20% 80%, oklch(15% 0.08 280 / 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, oklch(15% 0.08 220 / 0.2) 0%, transparent 50%)
              `
              : `
                linear-gradient(135deg, 
                  oklch(97% 0.01 220) 0%, 
                  oklch(95% 0.02 240) 50%, 
                  oklch(96% 0.015 200) 100%
                ),
                radial-gradient(circle at 20% 80%, oklch(85% 0.05 280 / 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, oklch(90% 0.03 220 / 0.08) 0%, transparent 50%)
              `,
            backgroundAttachment: 'fixed',
            minHeight: '100vh',
            fontFamily: DESIGN_TOKENS.typography.families.primary,
            fontSize: DESIGN_TOKENS.typography.scale.base.fontSize,
            lineHeight: DESIGN_TOKENS.typography.scale.base.lineHeight,
            color: semanticTokens.text.primary, // ðŸŽ¯ Usar token semÃ¡ntico
            transition: `all ${DESIGN_TOKENS.transitions.duration.normal} ${DESIGN_TOKENS.transitions.easing.inOut}`,
          },
          '*': {
            boxSizing: 'border-box',
            // ðŸš€ FINTECH 2025: InyecciÃ³n global de tokens semÃ¡nticos OKLCH
            ...generateCSSVariables(semanticTokens),
          },
          'html, body': {
            margin: 0,
            padding: 0,
          },
        },
      },
      MuiPaper: {
        styleOverrides: {
          root: {
            backgroundImage: 'none',
            background: colorScheme === 'dark' 
              ? 'rgba(24, 24, 27, 0.8)'
              : 'rgba(255, 255, 255, 0.8)',
            backdropFilter: 'blur(16px) saturate(160%) brightness(1.15)',
            border: `1px solid ${colorScheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(99, 102, 241, 0.2)'}`,
            boxShadow: shadows.card,
            transition: `all ${DESIGN_TOKENS.transitions.duration.normal} ${DESIGN_TOKENS.transitions.easing.inOut}`,
          },
        },
      },
      MuiButton: {
        styleOverrides: {
          root: {
            borderRadius: DESIGN_TOKENS.radius.lg,
            textTransform: 'none',
            fontWeight: DESIGN_TOKENS.typography.weights.medium,
            transition: `all ${DESIGN_TOKENS.transitions.duration.fast} ${DESIGN_TOKENS.transitions.easing.out}`,
            '&:hover': {
              transform: 'translateY(-2px)',
              boxShadow: shadows.lg,
            },
          },
          contained: {
            background: DESIGN_TOKENS.effects.gradient.primary[colorScheme],
            '&:hover': {
              background: DESIGN_TOKENS.effects.gradient.primary[colorScheme],
              filter: 'brightness(1.1)',
            },
          },
          outlined: {
            border: `2px solid ${palette.primary[500]}`,
            '&:hover': {
              background: colorUtils.withAlpha(palette.primary[500], 0.1),
            },
          },
        },
      },
      MuiCard: {
        styleOverrides: {
          root: {
            borderRadius: DESIGN_TOKENS.radius['2xl'],
            background: colorScheme === 'dark' 
              ? 'rgba(24, 24, 27, 0.8)'
              : 'rgba(255, 255, 255, 0.8)',
            backdropFilter: 'blur(16px) saturate(160%) brightness(1.15)',
            border: `1px solid ${colorScheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(99, 102, 241, 0.2)'}`,
            boxShadow: shadows.card,
            transition: `all ${DESIGN_TOKENS.transitions.duration.normal} ${DESIGN_TOKENS.transitions.easing.inOut}`,
            '&:hover': {
              transform: 'translateY(-4px)',
              boxShadow: shadows.floating,
            },
          },
        },
      },
      MuiTextField: {
        styleOverrides: {
          root: {
            '& .MuiOutlinedInput-root': {
              borderRadius: DESIGN_TOKENS.radius.lg,
              background: colorScheme === 'dark' 
                ? 'rgba(24, 24, 27, 0.6)'
                : 'rgba(255, 255, 255, 0.6)',
              backdropFilter: 'blur(8px) saturate(120%) brightness(1.1)',
              border: `1px solid ${colorScheme === 'dark' ? 'rgba(255, 255, 255, 0.08)' : 'rgba(99, 102, 241, 0.2)'}`,
              transition: `all ${DESIGN_TOKENS.transitions.duration.fast} ${DESIGN_TOKENS.transitions.easing.out}`,
              '&:hover': {
                borderColor: palette.primary[500],
                boxShadow: `0 0 0 3px ${colorUtils.withAlpha(palette.primary[500], 0.1)}`,
              },
              '&.Mui-focused': {
                borderColor: palette.primary[500],
                boxShadow: `0 0 0 3px ${colorUtils.withAlpha(palette.primary[500], 0.2)}`,
              },
            },
          },
        },
      },
    },

    // ðŸ“ TipografÃ­a moderna y legible
    typography: {
      fontFamily: DESIGN_TOKENS.typography.families.primary,
      fontWeightLight: DESIGN_TOKENS.typography.weights.light,
      fontWeightRegular: DESIGN_TOKENS.typography.weights.normal,
      fontWeightMedium: DESIGN_TOKENS.typography.weights.medium,
      fontWeightBold: DESIGN_TOKENS.typography.weights.bold,
      
      // Escala tipogrÃ¡fica optimizada
      h1: {
        ...DESIGN_TOKENS.typography.scale['4xl'],
        color: palette.text.primary,
        fontFamily: DESIGN_TOKENS.typography.families.display,
        background: DESIGN_TOKENS.effects.gradient.primary[colorScheme],
        WebkitBackgroundClip: 'text',
        WebkitTextFillColor: 'transparent',
        backgroundClip: 'text',
      },
      h2: {
        ...DESIGN_TOKENS.typography.scale['3xl'],
        color: palette.text.primary,
        fontFamily: DESIGN_TOKENS.typography.families.display,
      },
      h3: {
        ...DESIGN_TOKENS.typography.scale['2xl'],
        color: palette.text.primary,
        fontFamily: DESIGN_TOKENS.typography.families.display,
      },
      h4: {
        ...DESIGN_TOKENS.typography.scale.xl,
        color: palette.text.primary,
      },
      h5: {
        ...DESIGN_TOKENS.typography.scale.lg,
        color: palette.text.primary,
      },
      h6: {
        ...DESIGN_TOKENS.typography.scale.base,
        color: palette.text.primary,
        fontWeight: DESIGN_TOKENS.typography.weights.semibold,
      },
      subtitle1: {
        ...DESIGN_TOKENS.typography.scale.lg,
        color: palette.text.secondary,
      },
      subtitle2: {
        ...DESIGN_TOKENS.typography.scale.base,
        color: palette.text.secondary,
        fontWeight: DESIGN_TOKENS.typography.weights.medium,
      },
      body1: {
        ...DESIGN_TOKENS.typography.scale.base,
        color: palette.text.primary,
      },
      body2: {
        ...DESIGN_TOKENS.typography.scale.sm,
        color: palette.text.secondary,
      },
      caption: {
        ...DESIGN_TOKENS.typography.scale.xs,
        color: palette.text.tertiary,
      },
      button: {
        ...DESIGN_TOKENS.typography.scale.sm,
        fontWeight: DESIGN_TOKENS.typography.weights.medium,
        textTransform: 'none',
      },
    },

    // ðŸŒŸ Sistema de sombras mejorado
    shadows: [
      'none',
      shadows.xs,
      shadows.sm,
      shadows.md,
      shadows.lg,
      shadows.xl,
      shadows['2xl'],
      shadows.inner,
      shadows.glow,
      shadows.card,
      shadows.floating,
      // Extender array para satisfacer TypeScript
      ...Array(14).fill(shadows.md),
    ] as any,

    // ðŸ”˜ Border radius consistente
    shape: {
      borderRadius: parseInt(DESIGN_TOKENS.radius.lg.replace('rem', '')) * 16, // Convert rem to px
    },

    // âš¡ Transiciones optimizadas
    transitions: {
      create: (props: string | string[], options?: any) => {
        const duration = options?.duration || DESIGN_TOKENS.transitions.duration.normal;
        const easing = options?.easing || DESIGN_TOKENS.transitions.easing.inOut;
        return `${props} ${duration} ${easing}`;
      },
      easing: {
        easeInOut: DESIGN_TOKENS.transitions.easing.inOut,
        easeOut: DESIGN_TOKENS.transitions.easing.out,
        easeIn: DESIGN_TOKENS.transitions.easing.in,
        sharp: 'cubic-bezier(0.4, 0, 0.6, 1)',
      },
      duration: {
        shortest: parseInt(DESIGN_TOKENS.transitions.duration.instant.replace('ms', '')),
        shorter: parseInt(DESIGN_TOKENS.transitions.duration.fast.replace('ms', '')),
        short: parseInt(DESIGN_TOKENS.transitions.duration.normal.replace('ms', '')),
        standard: parseInt(DESIGN_TOKENS.transitions.duration.normal.replace('ms', '')),
        complex: parseInt(DESIGN_TOKENS.transitions.duration.slow.replace('ms', '')),
        enteringScreen: parseInt(DESIGN_TOKENS.transitions.duration.normal.replace('ms', '')),
        leavingScreen: parseInt(DESIGN_TOKENS.transitions.duration.fast.replace('ms', '')),
      },
    },

  });

  return responsiveFontSizes(baseTheme);
};

// ðŸŽ¯ PROVIDER PRINCIPAL
export const UnifiedThemeProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const systemPrefersDark = useMediaQuery('(prefers-color-scheme: dark)');
  const [mode, setMode] = useState<ThemeMode>('auto');

  // ðŸŽ¨ Determinar esquema de color
  const colorScheme: ColorScheme = useMemo(() => {
    if (mode === 'auto') {
      return systemPrefersDark ? 'dark' : 'light';
    }
    return mode;
  }, [mode, systemPrefersDark]);

  // ðŸŽ­ Crear tema dinÃ¡mico
  const theme = useMemo(() => createProfessionalTheme(colorScheme), [colorScheme]);

  // ðŸ”„ Cambiar modo de tema
  const handleSetMode = useCallback((newMode: ThemeMode) => {
    setMode(newMode);
    // Aplicar al HTML para CSS variables
    document.documentElement.setAttribute('data-theme', newMode === 'auto' ? (systemPrefersDark ? 'dark' : 'light') : newMode);
  }, [systemPrefersDark]);

  // ðŸ”„ Alternar esquema de color
  const toggleColorScheme = useCallback(() => {
    const newMode = colorScheme === 'light' ? 'dark' : 'light';
    handleSetMode(newMode);
  }, [colorScheme, handleSetMode]);

  // ðŸŽ¯ Efectos de inicializaciÃ³n
  useEffect(() => {
    // Aplicar tema inicial
    document.documentElement.setAttribute('data-theme', colorScheme);
    
    // Precargar fuentes crÃ­ticas
    const link = document.createElement('link');
    link.rel = 'preload';
    link.as = 'font';
    link.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap';
    link.crossOrigin = 'anonymous';
    document.head.appendChild(link);
  }, [colorScheme]);

  // ðŸŽ­ Contexto del tema
  const contextValue = useMemo(() => ({
    mode,
    colorScheme,
    setMode: handleSetMode,
    toggleColorScheme,
    systemPrefersDark,
    theme,
  }), [mode, colorScheme, handleSetMode, toggleColorScheme, systemPrefersDark, theme]);

  return (
    <UnifiedThemeContext.Provider value={contextValue}>
      <MuiThemeProvider theme={theme}>
        <CssBaseline />
        {children}
      </MuiThemeProvider>
    </UnifiedThemeContext.Provider>
  );
};

// ðŸŽ¯ Hook para usar el tema
export const useUnifiedTheme = () => {
  const context = useContext(UnifiedThemeContext);
  if (!context) {
    throw new Error('useUnifiedTheme must be used within a UnifiedThemeProvider');
  }
  return context;
}; 